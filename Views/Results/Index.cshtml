@model List<INF4001N_1814748_NVSAAY001_2024.ViewModels.ResultsViewModel>

@{
    ViewBag.Title = "Election Results";
    Layout = "~/Views/Shared/_Layout.cshtml";

    // Prepare data as a serialized JSON object
    var serializedData = Newtonsoft.Json.JsonConvert.SerializeObject(Model);
}

<h2 class="text-center results-title">Election Results</h2>

<div class="container mt-5">
    @foreach (var election in Model)
    {
        <div class="mb-5">
            <h3 class="text-center election-title">@election.ElectionTitle</h3>

            <div class="stats-container text-center mb-4">
                <p>
                    <strong>Total Votes Cast:</strong> @election.TotalVotes<br>
                    <strong>Percentage of Population Voted:</strong> @election.PopulationPercentageVoted.ToString("0.00")%<br>
                </p>
            </div>

            <table class="table table-striped table-hover table-bordered text-center">
                <thead class="table-header">
                    <tr>
                        <th>Candidate</th>
                        <th>Percentage of Votes</th>
                    </tr>
                </thead>
                <tbody>
                    @for (int i = 0; i < election.CandidateNames.Count; i++)
                    {
                        <tr>
                            <td>@election.CandidateNames[i]</td>
                            <td>@election.CandidateVotePercentages[i].ToString("0.00")%</td>
                        </tr>
                    }
                </tbody>
            </table>

            <canvas id="chart-@election.ElectionTitle.Replace(" ", "-")" class="results-chart"></canvas>
        </div>
    }
</div>

@section Scripts {
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script>
        const electionsData = @Html.Raw(@serializedData);

        document.addEventListener("DOMContentLoaded", function () {
            electionsData.forEach(election => {
                const ctx = document.getElementById(`chart-${election.ElectionTitle.replace(/\s+/g, "-")}`).getContext("2d");

                const imageUrls = election.CandidatePhotos;
                const images = [];
                imageUrls.forEach((url, index) => {
                    const img = new Image();
                    img.src = url;
                    images.push(img);
                });

                new Chart(ctx, {
                    type: 'bar',
                    data: {
                        labels: election.CandidateNames,
                        datasets: [{
                            label: 'Votes',
                            data: election.VoteCounts,
                            backgroundColor: 'rgba(54, 162, 235, 0.2)',
                            borderColor: 'rgba(54, 162, 235, 1)',
                            borderWidth: 1
                        }]
                    },
                    options: {
                        responsive: true,
                        plugins: {
                            legend: {
                                display: false
                            },
                            tooltip: {
                                enabled: true
                            }
                        },
                        scales: {
                            y: {
                                beginAtZero: true
                            }
                        }
                    },
                    plugins: [{
                        id: 'customLabels',
                        afterDraw: (chart) => {
                            const ctx = chart.ctx;
                            const xAxis = chart.scales.x;

                            images.forEach((img, index) => {
                                const x = xAxis.getPixelForValue(index) - 20;
                                const y = chart.scales.y.top - 50;
                                ctx.drawImage(img, x, y, 40, 40);
                            });
                        }
                    }]
                });
            });
        });
    </script>
}

<style>
    body {
        background-color: #f8f9fa;
        color: #212529;
    }

    .results-title {
        font-weight: bold;
        color: #0047ab; /* South African blue */
        text-shadow: 1px 1px 5px rgba(0, 0, 0, 0.2);
    }

    .election-title {
        font-weight: bold;
        color: #28a745; /* South African green */
        margin-bottom: 20px;
    }

    .stats-container {
        background-color: #fffbea;
        border: 2px solid #ffb400; /* South African gold */
        border-radius: 10px;
        padding: 15px;
        margin: 20px 0;
        font-size: 1.1rem;
    }

    .table {
        margin-top: 20px;
        background-color: #ffffff;
    }

    .table-header {
        background-color: #0047ab; /* South African blue */
        color: white;
    }

    .table-hover tbody tr:hover {
        background-color: #f1f8f5;
    }

    .table-bordered th,
    .table-bordered td {
        border: 2px solid #ddd;
    }

    .results-chart {
        margin: 20px auto;
        width: 1000px;
        border: 2px solid #28a745; /* South African green */
        border-radius: 10px;
        background-color: white;
    }
</style>